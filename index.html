<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>encrypt me</title>
	</head>
	<body>
		<p>
		INPUT
		</p>
		<textarea class="input-area" rows="10" cols="100"></textarea>
		
		<p>
		KEY
		</p>
		<textarea class="key-area" rows="3" cols="100"></textarea>
		
		<p>
		OUTPUT
		</p>
		<textarea class="output-area" rows="10" cols="100"></textarea>


		<div class="action-group">
		  <button class="generate-key">Generate Key</button>
		  <button class="encrypt">Encrypt</button>
		  <button class="decrypt">Decrypt</button>
		</div>
		
		
		<script>
			document.addEventListener("DOMContentLoaded", function(event) {
				
				
				let generateKeyBtn = document.querySelector('.generate-key');
				let encryptBtn = document.querySelector('.encrypt');
				let decryptBtn = document.querySelector('.decrypt');
				
				
				generateKeyBtn.addEventListener('click', async ()=>{
					let jwk = await generateKey();
					document.querySelector('.key-area').innerText = jwk.k;
				});
				
				encryptBtn.addEventListener('click', async ()=> {
					let jwk = document.querySelector('.key-area').value;					
					let encryptedData = await encrypt(jwk, document.querySelector('.input-area').value);					
					document.querySelector('.output-area').innerText = encryptedData;					
				});
				
				decryptBtn.addEventListener('click', async ()=> {
					let jwk = document.querySelector('.key-area').value;					
					let decryptedData = await decrypt(jwk, document.querySelector('.input-area').value);					
					document.querySelector('.output-area').innerText = decryptedData;
				});
			});
			
			async function generateKey() {
				let key = await window.crypto.subtle.generateKey({name: "AES-CTR",length: 256,},true,["encrypt", "decrypt"]);
				let jwk = await window.crypto.subtle.exportKey("jwk", key);
				return jwk;
			}

			async function encrypt(jwkKey, data) {
			  data = str2ab(data);
			  let importKey = await window.crypto.subtle.importKey("jwk", { kty: "oct",k: jwkKey, alg: "A256CTR", ext: true,},{ name: "AES-CTR",},true,["encrypt", "decrypt"])
			  let encrypted = await window.crypto.subtle.encrypt({name: "AES-CTR",counter: new Uint8Array(16),length: 128,},importKey,data);
			  encrypted = new Uint8Array(encrypted);  
			  let base64Data = btoa(encrypted.reduce((data, byte) => data + String.fromCharCode(byte), ''))
			  console.log(base64Data);
			  return base64Data;
			}

			async function decrypt(jwkKey, data) {
				let importKey = await window.crypto.subtle.importKey("jwk", { kty: "oct",k: jwkKey, alg: "A256CTR", ext: true,},{ name: "AES-CTR",},true,["encrypt", "decrypt"])
				let base64Decoded = atob(data);
				let bufferData = new Uint8Array([...base64Decoded].map(char => char.charCodeAt(0)));
				let decrypted = await window.crypto.subtle.decrypt({name: "AES-CTR",counter: new Uint8Array(16),length: 128,},importKey,bufferData );
				console.log(ab2str(decrypted))
				return ab2str(decrypted);
			}

			function ab2str(buf) {
			  return String.fromCharCode.apply(null, new Uint16Array(buf));
			}

			function str2ab(str) {
			  let buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
			  let bufView = new Uint16Array(buf);
			  for (let i=0, strLen=str.length; i < strLen; i++) {
				bufView[i] = str.charCodeAt(i);
			  }
			  return buf;
			}

			
		</script>
	</body>
</html>